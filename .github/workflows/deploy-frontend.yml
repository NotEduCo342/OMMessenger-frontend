name: Deploy Frontend (VPS Build)

on:
  push:
    branches: [ main ]

env:
  BRANCH_NAME: ${{ github.ref_name }}
  COMMIT_SHA: ${{ github.sha }}
  COMMIT_MSG: ${{ github.event.head_commit.message }}
  AUTHOR: ${{ github.actor }}
  RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
    # ==========================================
    # STEP 1: Deployment Started Notification
    # ==========================================
    - name: üì¢ Notify Deployment Started
      run: |
        curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
          -d chat_id="${{ secrets.TELEGRAM_CHAT_ID }}" \
          -d message_thread_id="2" \
          -d parse_mode="Markdown" \
          -d text="üîÑ *Frontend Deployment Started*

        üì¶ Project: OM Messenger Frontend
        üåø Branch: ${{ env.BRANCH_NAME }}
        üè∑Ô∏è Environment: üü¢ Production

        üë§ Author: ${{ env.AUTHOR }}
        üí¨ Message: ${{ env.COMMIT_MSG }}

        ‚è≥ Connecting to VPS..."

    # ==========================================
    # STEP 2: SSH -> Pull -> Build -> Deploy
    # ==========================================
    - name: üö¢ Deploy to VPS
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.VPS_HOST }}
        username: ${{ secrets.VPS_USER }}
        key: ${{ secrets.VPS_SSH_KEY }}
        port: ${{ secrets.VPS_PORT }}
        script: |
          echo "üöÄ Starting Deployment on VPS..."
          
          # Navigate to project directory
          PROJECT_PATH="${{ secrets.PROJECT_PATH }}"
          cd $PROJECT_PATH || { echo "‚ùå Directory $PROJECT_PATH not found"; exit 1; }
          
          # Pull latest code
          echo "üì• Pulling latest changes..."
          git fetch origin main
          git reset --hard origin/main
          
          # Build and Start Containers
          echo "üèóÔ∏è Building and Starting Containers..."
          docker compose down
          docker compose up -d --build
          
          # Cleanup unused images
          docker image prune -f

    # ==========================================
    # STEP 3: Success Notification
    # ==========================================
    - name: ‚úÖ Notify Success
      if: success()
      run: |
        curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
          -d chat_id="${{ secrets.TELEGRAM_CHAT_ID }}" \
          -d message_thread_id="2" \
          -d parse_mode="Markdown" \
          -d text="‚úÖ *Frontend Deployment Successful*

        üöÄ The application has been successfully built and deployed on the VPS.
        
        üîó [View Workflow](${{ env.RUN_URL }})"

    # ==========================================
    # STEP 4: Failure Notification
    # ==========================================
    - name: ‚ùå Notify Failure
      if: failure()
      run: |
        curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
          -d chat_id="${{ secrets.TELEGRAM_CHAT_ID }}" \
          -d message_thread_id="2" \
          -d parse_mode="Markdown" \
          -d text="‚ùå *Frontend Deployment Failed*

        ‚ö†Ô∏è An error occurred during the deployment process.
        
        üîó [View Logs](${{ env.RUN_URL }})"
